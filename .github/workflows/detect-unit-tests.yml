name: Detect Unit Test PR and Print .spec.js Files as JSON

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-spec-files:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for full git history and diff

      - name: Detect and Print .spec.js files
        run: |
          echo "üîç Checking for .spec.js files in PR..."

          BASE="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$BASE"

          # Get the list of changed .spec.js files
          FILES=$(git diff --name-only origin/"$BASE"...HEAD | grep '\.spec\.js$' || true)

          if [ -z "$FILES" ]; then
            echo "‚ÑπÔ∏è No .spec.js files found in this PR."
            exit 0
          fi

          echo "‚úÖ Detected the following .spec.js files:"
          echo "$FILES"

          # Start JSON object
          echo "üì¶ Printing file contents as JSON:"
          echo "{"
          FIRST=1
          for FILE in $FILES; do
            if [ -f "$FILE" ]; then
              CONTENT=$(jq -Rs . < "$FILE")  # Read and JSON-escape file content
              if [ $FIRST -eq 1 ]; then
                FIRST=0
              else
                echo ","
              fi
              echo -n "  \"$FILE\": $CONTENT"
            fi
          done
          echo ""
          echo "}"
