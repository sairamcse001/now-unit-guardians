name: Jest Coverage and Test Summary Extraction

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-and-summary:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¥ Install dependencies
        run: npm install

      - name: ğŸ§ª Run Jest with Coverage and Capture Output
        run: |
          mkdir -p temp
          npx jest --coverage --coverageReporters=text > temp/jest-output.txt
          cat temp/jest-output.txt

      - name: ğŸ“Š Parse Jest Coverage Table Summary to JSON
        run: |
          node <<'EOF'
          const fs = require('fs');
          const text = fs.readFileSync('./temp/jest-output.txt', 'utf-8');
          const lines = text.split('\n');

          const start = lines.findIndex(line => line.includes('File')) + 1;
          const end = lines.findIndex((line, i) => i > start && line.trim() === '');

          const data = [];

          for (let i = start; i < end; i++) {
            const line = lines[i].trim();
            if (!line || line.startsWith('---')) continue;

            const parts = line.split('|').map(part => part.trim());
            if (parts.length < 6) continue;

            data.push({
              file: parts[0],
              statements: parts[1],
              branches: parts[2],
              functions: parts[3],
              lines: parts[4],
              uncovered: parts[5] || ''
            });
          }

          fs.writeFileSync('coverage-table-summary.json', JSON.stringify(data, null, 2));
          EOF

      - name: ğŸ“„ Extract Jest Test Summary and Passed Files
        run: |
          node <<'EOF'
          const fs = require('fs');
          const text = fs.readFileSync('./temp/jest-output.txt', 'utf-8');
          const lines = text.split('\n');

          const summary = {
            passedFiles: [],
            suites: '',
            tests: '',
            snapshots: '',
            time: ''
          };

          for (const line of lines) {
            if (line.startsWith('PASS')) {
              summary.passedFiles.push(line.trim());
            }

            if (/^Test Suites:/.test(line)) {
              summary.suites = line.trim();
            }

            if (/^Tests:/.test(line)) {
              summary.tests = line.trim();
            }

            if (/^Snapshots:/.test(line)) {
              summary.snapshots = line.trim();
            }

            if (/^Time:/.test(line)) {
              summary.time = line.trim();
            }
          }

          fs.writeFileSync('jest-run-summary.json', JSON.stringify(summary, null, 2));
          EOF

      - name: ğŸ—‚ Upload JSON Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jest-summary-json
          path: |
            coverage-table-summary.json
            jest-run-summary.json
